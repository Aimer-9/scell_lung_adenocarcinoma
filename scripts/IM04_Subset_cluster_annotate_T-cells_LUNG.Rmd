---
title: "Untitled"
output: html_document
---

More detailed Immune phenotyping of different immune cell types
T-cels 
Load immune workspace
```{r}
rm(list=ls())
dir <- "/home/ubuntu/scell_lung_adenocarcinoma/"
# dir <- "/myVolume/scell_lung_adenocarcinoma/"
load(file=paste(dir,"Data_input/objects/IM01_Immune_Seurat_object_new.RData", sep=""))
```

Biopsy site vs analysis all cell types 
```{r}
require(gplots)
tab.1 <- table(tiss_immune@meta.data$biopsy_site, tiss_immune@meta.data$analysis)
balloonplot(tab.1, main ="Response vs Biopsy site for all cells", xlab ="", ylab="",
            label = T, show.margins = F)
```

Table of Biopsy site vs analysis 
```{r}
cells <- row.names(tiss_immune@meta.data)[which(tiss_immune@meta.data$biopsy_site == "Lung")]
tiss.temp <- subset(tiss_immune, cells=cells)
tab.1 <- table(tiss.temp@meta.data$analysis, tiss.temp@meta.data$immune_subtype_annotation )
balloonplot(tab.1, main ="Cell types vs treatment for Lung", xlab ="", ylab="",
            label = T, show.margins = F)
rm(tiss.temp)
```

Subset Macrophages and Monocytes From Lung 
```{r}
t.cells <- tiss_immune@meta.data[which(tiss_immune@meta.data$biopsy_site == "Lung"),]
dim(t.cells)
t.cells.2 <- t.cells[which(t.cells$immune_subtype_annotation == "T-cells"),]
dim(t.cells.2)
t.cell.tiss <- subset(tiss_immune, cells=row.names(t.cells.2)  )  
t.cell.tiss
```

Biopsy site vs analysis sanity check 
```{r}
tab.1 <- table(t.cell.tiss@meta.data$biopsy_site, t.cell.tiss@meta.data$analysis)
balloonplot(tab.1, main ="Response vs Biopsy site", xlab ="", ylab="",
            label = T, show.margins = F)
```

Unsupervised clustering of Myeloid cells

Find variable genes
```{r}
t.cell.tiss <- FindVariableFeatures(object = t.cell.tiss, num.bin = 20, binning.method = "equal_width")
```

Unsupervised clustering of Myeloid cells

Perform PCA
```{r}
t.cell.tiss <- RunPCA(object = t.cell.tiss, do.print = FALSE)
```

Visualize variance along each component
```{r}
ElbowPlot(t.cell.tiss)
```

Visualize first two PCs
```{r}
PCAPlot(object = t.cell.tiss)
```

Visualize top genes and their loadings 
```{r}
VizDimLoadings(t.cell.tiss, dims = 1:5, reduction = "pca", nfeatures = 10)
```

Visualize top genes in principal components
```{r}
DimHeatmap(t.cell.tiss, dims = 1:10, cells = 100, balanced = TRUE)
```

Construct Neighbor graph 
```{r}
t.cell.tiss <- FindNeighbors(object = t.cell.tiss, verbose = T)
```

Find Clusters 
```{r}
t.cell.tiss <- FindClusters(object = t.cell.tiss, verbose = T, resolution = 0.3)
```
Run and project TSNEs
```{r}
t.cell.tiss <- RunTSNE(t.cell.tiss, dims = 1:5)
DimPlot(t.cell.tiss, reduction = "tsne")
```

# Plot TSNE and save 
```{r}
pdf(paste(dir, "plot_out/IM04/TCell_TSNE_manuscript.pdf",sep=""), 5,5)
DimPlot(t.cell.tiss, reduction = "tsne")
DimPlot(t.cell.tiss, reduction = "tsne", label = T)
dev.off()
```
# Plot TSNE with analysis colors 
```{r}
Idents(object = t.cell.tiss) <- t.cell.tiss@meta.data$analysis
DimPlot(t.cell.tiss, reduction = "tsne", label = T)
Idents(object = t.cell.tiss) <- t.cell.tiss@meta.data$SmartSeq2_snn_res.0.3
# DimPlot(t.cell.tiss, reduction = "tsne", label = T)
```

# Plot TSNE with analysis colors 
```{r}
Idents(object = t.cell.tiss) <- t.cell.tiss@meta.data$patient_id
DimPlot(t.cell.tiss, reduction = "tsne", label = F)
Idents(object = t.cell.tiss) <- t.cell.tiss@meta.data$SmartSeq2_snn_res.0.3
# DimPlot(t.cell.tiss, reduction = "tsne", label = T)
```


```{r}
tab.1 <- table(t.cell.tiss@meta.data$SmartSeq2_snn_res.0.3, t.cell.tiss@meta.data$analysis)
balloonplot(tab.1, main ="Response vs T-cell cluster", xlab ="", ylab="",
            label = T, show.margins = F)
```

```{r}
require(reshape)
tab.1 <- prop.table(table(t.cell.tiss@meta.data$SmartSeq2_snn_res.0.3, t.cell.tiss@meta.data$analysis), margin = 1)
tab.1 <- melt(tab.1)
tab.1$Var1 <- as.factor(tab.1$Var1)
fraction.plot <- ggplot() + geom_bar(aes(y = value, x = Var1, fill = Var2), data = tab.1,
                           stat="identity" , position=position_dodge())
ggsave(filename = paste(dir, "plot_out/IM04/Tcell_TSNE_clusters_by_treatment_manuscript.pdf",sep=""), plot = fraction.plot, width = 7,height = 5)
fraction.plot
```

Replot barplots using error bars 
```{r}
library(ggrepel)
require(qdapTools)
require(REdaS)
require(plyr)
meta.temp <- t.cell.tiss@meta.data
meta.temp$SmartSeq2_snn_res.0.3 <- as.numeric(as.character(meta.temp$SmartSeq2_snn_res.0.3))
# Change res clusters to MF clusters 
meta.temp$cluster <- mapvalues(meta.temp$SmartSeq2_snn_res.0.3, from=c(0,1,2,3,4,5), to=c("TC0", "TC1", "TC2","TC3", "TC4", "TC5"))
# Calculate fractions and error bars 
prop.table.error <- list()
for(i in 1:length(unique(meta.temp$cluster))){
vec.temp <- meta.temp[meta.temp$cluster==unique(meta.temp$cluster)[i],"analysis"]
# Convert to counts and calculate 95% CI 
# Store in list 
table.temp <- freqCI(vec.temp, level = c(.95))
prop.table.error[[i]] <- print(table.temp, percent = TRUE, digits = 3)
# 
}
# Name list 
names(prop.table.error) <- unique(meta.temp$cluster)
# Convert to data frame 
tab.1 <- as.data.frame.array(do.call(rbind, prop.table.error))
# Add analysis column 
b <- c()
a <- c()
for(i in names(prop.table.error)){
  a <- rep(i,3)
  b <- c(b,a)
}
tab.1$cluster <- b
tab.1$cell <- rep(row.names(tab.1)[1:3], length(unique(tab.1$cluster)))
# Resort factor analysis 
tab.1$cluster <- factor(tab.1$cluster, levels = c("TC0", "TC1", "TC2","TC3", "TC4", "TC5"))
# Rename percentile columns 
colnames(tab.1)[1] <- "lower"
colnames(tab.1)[3] <- "upper"
# 
p <- ggplot(tab.1, aes(x=cluster, y=Estimate, fill=cell)) + 
    geom_bar(position=position_dodge(), stat="identity") +
    geom_errorbar(aes(ymin=lower, ymax=upper), width=.2,position=position_dodge(0.9)) + 
    theme(legend.position="bottom")
# Save plot 
ggsave(filename = paste(dir, "plot_out/IM04/Tcell_TSNE_clusters_by_treatment_with_error_bars_manuscript.pdf",sep=""), plot = p, width = 7,height = 5)
p
```

Significance between fractions 
Chi-square Test of Independence  
```{r}
count.mat <- as.matrix(table(meta.temp$analysis, meta.temp$cluster))
p.mat <- matrix(nrow = ncol(count.mat), ncol=1)
row.names(p.mat) <- colnames(count.mat)
for(i in 1:ncol(count.mat)){
  test <- chisq.test(count.mat[,i])
  p.mat[i,1] <- test$p.value*ncol(count.mat)
}
p.mat[,1]
```


```{r}
tab.1 <- table(t.cell.tiss@meta.data$SmartSeq2_snn_res.0.3, as.character(t.cell.tiss@meta.data$patient_id))
balloonplot(tab.1, main ="Patient ID vs T-cell cluster", xlab ="", ylab="",
            label = T, show.margins = F)
table(tiss_immune@meta.data$patient_id, tiss_immune@meta.data$biopsy_site)
```

```{r}
tab.1 <- table(t.cell.tiss@meta.data$analysis, as.character(t.cell.tiss@meta.data$patient_id))
balloonplot(tab.1, main ="Patient ID vs Treatment response", xlab ="", ylab="",
            label = T, show.margins = F)
```

Plot custom genes
```{r}
genes <- c("MR1", "NCAM1", "IFNG", "CXCR5", "IL17A", "CCR5", "CCR3", "IL12A","IL12B", "IL4", "IL5", "IL13", "CCR4", "IL1B")
a <- VlnPlot(t.cell.tiss, features = genes, pt.size = 1)
ggsave(filename = paste(dir, "plot_out/IM04/Annotation_Markers_of_Tcells.pdf",sep=""),plot = a,width = 15,height = 15)
a
```


Plot top genes annotate by reponse
```{r}
genes <- c("CD3E","CD4","CD8A","CTLA4","PDCD1","IFNG","LAG3", "FOXP3", "EOMES", "GZMK", "FCGR3A", "TOP2A")
a <- VlnPlot(t.cell.tiss, features = genes,pt.size = 0)
ggsave(filename = paste(dir, "plot_out/IM04/Markers_of_PD_Tcells.pdf",sep=""),plot = a,width = 10,height = 10)
a <- DoHeatmap(t.cell.tiss, features = genes)
ggsave(filename = paste(dir, "plot_out/IM04/Markers_of_PD_Tcells_heatmap.pdf",sep=""),plot = a,width = 10,height = 10)
a
```
Cluster0: generic dont really know. 
Cluster1: Exhaustion in the pD cluster (1) and the PD/PR cluster (4). (PR/PD feature) 
Cluster2: Cluster 2 is cytotoxic (GZMK, EOMES, CD8pos, IFNG) (Less in PD)
Cluster3: Cluster 3 is enriched for NK cells  (Naive feature)
Cluster4: Exhaustion in the pD cluster (1) and the PD/PR cluster (4). (PR/PD feature) 
Cluster5: FOXP3 positive Tregs in cluster 5 (Less in PR)







Find all cluster markers and
```{r}
t.cell.markers <- FindAllMarkers(object = t.cell.tiss, only.pos = TRUE, min.pct = 0.25, thresh.use = 0.25)
t.cell.markers %>% group_by(cluster) %>% top_n(10, avg_logFC) -> top10
top10$gene[1:10]
# t.cell.markers <- read.table(paste(dir, "data_out/IM04/T-cells_DE_genes_between_subclusters_Lung.csv",sep=""))
```

Plot top genes 
```{r}
require(tidyverse)
t.cell.markers %>% group_by(cluster) %>% top_n(10, avg_logFC) -> top10
t.cell.markers %>% group_by(cluster) %>% top_n(20, avg_logFC) -> top20
t.cell.markers %>% group_by(cluster) %>% top_n(50, avg_logFC) -> top50
a <- DoHeatmap(t.cell.tiss, features = top20$gene, raster = F)
ggsave(filename = paste(dir, "plot_out/IM04/Markers_of_Tcell_clusters_heatmap.pdf",sep=""),plot = a,width = 10,height = 15)
```

Write table of top genes 
```{r}
write.csv(t.cell.markers, paste(dir, "data_out/IM04/T-cells_DE_genes_between_subclusters_Lung.csv",sep=""), row.names=F)
```

Plot all relevant, PCA, tSNE and Clustering plots as pdf 
```{r}
pdf(paste(dir, "plot_out/IM04/T-cells_subclustering_TSNE_LUNG.pdf",sep=""),width = 10,height = 7)
# Tables
# 1
tab.1 <- table(t.cell.tiss@meta.data$SmartSeq2_snn_res.0.3, t.cell.tiss@meta.data$analysis)
balloonplot(tab.1, main ="T-cell subcluster vs Response group", xlab ="", ylab="",
            label = T, show.margins = F)
# 2
tab.1 <- table(t.cell.tiss@meta.data$SmartSeq2_snn_res.0.3, as.character(t.cell.tiss@meta.data$patient_id))
balloonplot(tab.1, main ="Patient ID vs T-cell cluster", xlab ="", ylab="",
            label = T, show.margins = F)
# TSNE plots 
DimPlot(object = t.cell.tiss, group.by="SmartSeq2_snn_res.0.3", reduction = "tsne", label = T)
DimPlot(object = t.cell.tiss, group.by="analysis", reduction = "tsne", label = T)
# Heatmaps
# DoHeatmap(t.cell.tiss, features = top10$gene)
# DoHeatmap(t.cell.tiss, features = top20$gene)
# DoHeatmap(t.cell.tiss, features = top50$gene)
genes <- c("CD3E","CD3G","CD4", "CD8A", "TOP2A", "FOXP3","CTLA4", "IL2RA", "PDCD1","CD28", "IL2", "CXCL13")
DoHeatmap(t.cell.tiss, features = genes)
# Violin plot 
Idents(object = t.cell.tiss) <- t.cell.tiss@meta.data$SmartSeq2_snn_res.0.3
genes <- c("CD3E","CD3G","CD4", "CD8A", "TOP2A", "FOXP3","CTLA4", "IL2RA", "PDCD1","CD28", "IL2")
VlnPlot(t.cell.tiss, features =  genes)
Idents(object = t.cell.tiss) <- t.cell.tiss@meta.data$analysis
VlnPlot(t.cell.tiss, features= genes)
Idents(object = t.cell.tiss) <- t.cell.tiss@meta.data$SmartSeq2_snn_res.0.3
# PCA plots 
# PCHeatmap(object = t.cell.tiss, pc.use = 1:15, cells.use = 100, do.balanced = TRUE, label.columns = FALSE, num.genes = 10)
# PCElbowPlot(object = t.cell.tiss)
#JackStrawPlot(t.cell.tiss, PCs = 1:12)
# Feature plot
# DotPlot(t.cell.tiss, top10$gene, x.lab.rot = T)
# DotPlot(t.cell.tiss, top10$gene, x.lab.rot = T, group.by = "analysis")
dev.off()
```
Save immune cell workspace 
```{r}
save(t.cell.tiss, file=paste(dir,"Data_input/objects/IM04_Tcells_Seurat_object.RData", sep=""))
```


T-cell subset analysis from derLeun et al (2020)
Unfinished
```{r}
t_temp <- read.csv(paste(dir,"gene_lists/T_cell_subset_markers_derLeun.csv", sep=""))
t_temp$gene <- as.character(t_temp$gene)
t_list <- split(t_temp$gene, t_temp$subset)
# Calculate Module scores with Seurat 
t.cell.tiss <- AddModuleScore(t.cell.tiss, features = t_list, name = names(t_list))
# Change metadata names cause Seurat seems to append a number that I am not sure how to change at this point 
colnames(t.cell.tiss@meta.data[(ncol(t.cell.tiss@meta.data)-(length(t_list)-1)):ncol(t.cell.tiss@meta.data)]) <- paste(names(t_list), c(1:7), sep = "")
names <- colnames(t.cell.tiss@meta.data[(ncol(t.cell.tiss@meta.data)-(length(t_list)-1)):ncol(t.cell.tiss@meta.data)])
# Plot 
VlnPlot(t.cell.tiss, features = names)
# Heatmap 
DoHeatmap(t.cell.tiss, features = t_temp$gene)
```


---
title: "Add metadata features from tracer"
author: "Lincoln Harris"
date: "7.13.18"
output:
  pdf_document: default
  html_document: default
---

## This is the workflow for reading in TRACER output to an existing Seurat object           

load libraries
```{r, comment=NA, messages=FALSE, warning=FALSE, results='hide'}
library(Seurat)
```

Load Seurat obj
```{r, comment=NA, messages=FALSE, warning=FALSE, results='hide'}
load("/myVolume/sclung_adeno/R_objects/04_main_seurat_subset_190128_immune_annotated.RData")
```

```{r, comment=NA}
dim(tiss_subset@meta.data)
```

```{r, echo=FALSE}
TSNEPlot(tiss_subset)
```

```{r, comment=NA}
colnames(tiss_subset@meta.data)
```

```{r}
unique(tiss_subset@meta.data$Final_immune_annotation)
```

Read in Tracer data
```{r, comment=NA}
# A/B summary
tracer_summary <- read.csv("../TCR_analysis/filtered_TCRAB_summary/cell_data.csv", header = T)
```

Lets define a new metadata df
  and add some new cols
```{r, comment=NA}
meta_edit <- tiss_subset@meta.data

meta_edit$A_productive <- NA
meta_edit$A_productive <- as.vector(meta_edit$A_productive)

meta_edit$B_productive <- NA
meta_edit$B_productive <- as.vector(meta_edit$B_productive)

meta_edit$clonal_group_AB <- NA
meta_edit$group_size_AB <- NA
```

Make sure cell IDs look the same
```{r, comment=NA}
tracer_summary$cell_name <- gsub("[.]", "_", tracer_summary$cell_name)
```

find cell name matches btwn meta_edit and tracer_summary
  this match() function is so much more efficient that looping!!
```{r, comment=NA}
match_vec <- match(row.names(meta_edit), tracer_summary$cell_name) # meta_edit first
match_vec1 <- match(tracer_summary$cell_name, row.names(meta_edit)) # tracer_summary first

length(match_vec)
length(match_vec1)

head(match_vec)
```

```{r, comment=NA}
length(unique(match_vec))
```

add tracer_summary info to meta_edit, based on cell name matches
```{r, comment=NA}
for (i in 1:length(match_vec)){
  currIndex <- match_vec[i]
  meta_edit$A_productive[i] <- as.vector(tracer_summary$A_productive[currIndex])
  meta_edit$B_productive[i] <- as.vector(tracer_summary$B_productive[currIndex])
}
```

now export to csv
```{r, comment=NA}
write.csv(meta_edit, "/myVolume/sclung_adeno/TCR_analysis/metadata_with_assembled_TCRs.csv")
```
